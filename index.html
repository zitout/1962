<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام بحث العملاء</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .search-container {
            position: relative;
            margin: 20px 0;
        }

        #searchInput {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item .name {
            font-weight: 500;
        }

        .suggestion-item .info {
            color: #666;
            font-size: 0.9em;
        }

        .client-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            font-weight: bold;
            width: 150px;
            color: #555;
        }

        .info-value {
            flex: 1;
        }

        mark {
            background-color: #fff3cd;
            padding: 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>نظام بحث العملاء</h1>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ابحث عن عميل...">
            <div id="suggestions" class="suggestions"></div>
        </div>
        <div id="clientInfo" class="client-info"></div>
    </div>

    <script>
        // بيانات العملاء
        const jsonData = [
            // هنا يتم إضافة البيانات من ملف data.js
        ];

        let clientsData = [];

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof jsonData !== 'undefined') {
                clientsData = jsonData;
                console.log('تم تحميل البيانات:', clientsData.length);
                setupSearch();
            } else {
                console.error('لم يتم العثور على البيانات!');
            }
        });

        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsDiv = document.getElementById('suggestions');
            
            searchInput.addEventListener('input', (e) => {
                const value = e.target.value.trim();
                
                if (value.length < 1) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                const suggestions = searchClients(value);
                displaySuggestions(suggestions);
            });

            // إخفاء الاقتراحات عند النقر خارج منطقة البحث
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        function searchClients(query) {
            if (!query) return [];
            
            query = query.trim().toLowerCase();
            return clientsData
                .filter(client => {
                    const name = client.الاسم.toLowerCase();
                    return (
                        name.includes(query) ||
                        calculateSimilarity(name, query) >= 0.4 ||
                        name.split(' ').some(word => word.startsWith(query))
                    );
                })
                .slice(0, 10);
        }

        function displaySuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            
            if (suggestions.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.style.display = 'block';
            
            suggestions.forEach(client => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `
                    <span class="name">${highlightMatch(client.الاسم, document.getElementById('searchInput').value)}</span>
                    <span class="info">${client.المهنة || ''}</span>
                `;
                div.onclick = () => {
                    document.getElementById('searchInput').value = client.الاسم;
                    displayClientInfo(client);
                    suggestionsDiv.style.display = 'none';
                };
                suggestionsDiv.appendChild(div);
            });
        }

        function displayClientInfo(client) {
            const clientInfoDiv = document.getElementById('clientInfo');
            let html = '<h2>معلومات العميل</h2>';
            
            for (let key in client) {
                if (client[key] !== null && client[key] !== undefined && client[key] !== '') {
                    html += `
                        <div class="info-row">
                            <span class="info-label">${key}:</span>
                            <span class="info-value">${client[key]}</span>
                        </div>`;
                }
            }
            
            clientInfoDiv.innerHTML = html;
        }

        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (shorter.length === 0) return 0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];

            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i-1) === a.charAt(j-1)) {
                        matrix[i][j] = matrix[i-1][j-1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i-1][j-1] + 1,
                            matrix[i][j-1] + 1,
                            matrix[i-1][j] + 1
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }
    </script>
</body>
</html>
